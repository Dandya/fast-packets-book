# Анализ системы AF_XDP

***

В данном разделе разбирается устройство системы AF_XDP, а также примеры её использования.

***

1. [Описание архитектуры]()
	1. [Применяемые механизмы и технологии](#применяемые-механизмы-и-технологии)
	2. [Доступные режимы](#доступные-режимы)
	3. [Процесс передачи сетевых пакетов]()
2. [Разбор примеров]()
	1. [Настройка сокета]()
	2. [Захват и отправка сетевых пакетов]()
3. [Заключение]()
4. [Полезные материалы]()
5. [Источники]()

***

## Описание архитектуры

### Применяемые механизмы и технологии

Аналогично системе «AF_PACKET» использует интерфейс сокетов ядра «Linux» для настройки режима работы. А для передачи пакетов между пользовательским процессом и ядром используется общая память, представляющая собой кольцевой буфер пакетов и имеющая название `UMEM`. При этом в ядре пакеты могут передаваться через структуры `sk_buff` или `xdp_buff`.

### Доступные режимы

Система «AF_XDP» поддерживает два режима работы:

1. `XDP_SKB` — режим работы, при котором данные для копирования в очередь берутся из структуры `sk_buff`;
2. `XDP_DRV` — режим работы, при котором сетевое устройство с помощью технологии DMA записывает пакеты напрямую в память пользовательского пространства.

С помощью установки флага `XDP_SHARED_UMEM` в аргументах системного вызова `bind` появляется возможность создания произвольного количества сокетов с одной разделяемой памятью, где метод распределения пакетов будет определяться XDP-программой загруженной в ядро «linux» и закрепленное за получением пакетов на определённом сетевом интерфейсе.

А при установке параметра `XDP_USE_SG` появляется возможность захватывать пакеты длиной до 9 килобайт, путём объединения буферов (фрагментов на уровне драйвера) в один дескриптор пакета. Захват больших пакетов также возможен через установку флага `XDP_UMEM_UNALIGNED_CHUNK_FLAG` с использованием технологии «hugepages», что с одной стороны увеличивает эффективность использования оперативной памяти из-за записи всех пакетов без пробелов и выравниваний, но увеличивает накладные расходы на управление памятью.

### Процесс передачи сетевых пакетов

Передача сетевых пакетов с использованием системы «AF_XDP» зависит не только от реализации сетевого стека ядра «Linux», но и от реализации драйвера. Проверить поддержку системы в драйвере можно по наличию флага `NETDEV_XDP_ACT_XSK_ZEROCOPY` в функции инициализации сетевого интерфейса.

```c
// contrib/linux-6.18/drivers/net/ethernet/intel/igb/igb_main.c
// Процесс инициализации доступных функций XDP.
static int igb_probe(struct pci_dev *pdev, const struct pci_device_id *ent)
{
	struct net_device *netdev;
	/* ... */
	netdev->xdp_features = NETDEV_XDP_ACT_BASIC | NETDEV_XDP_ACT_REDIRECT |
						NETDEV_XDP_ACT_XSK_ZEROCOPY;
	/* ... */
}
```

В работе системы ядро выполняет следующие функции:

- Настройка отображения памяти между пространством ядра и пространством пользователя;
- Настройка DMA для передачи пакетов;
- Загрузка в ядро XDP-программы;
- Управление памятью `UMEM`, а также очередями `RX`, `TX`, `FR`, `CR`.

Тогда как драйвер реализует следующие функции:

- Обработка прерываний;
- Фильтрация пакетов с помощью XDP.


Таким образом, большинство драйверов могут реализовать «zero-copy» режим передачи пакетов без необходимости вностить множество изменений в исходный код драйвера и реализовывать доступ из пространства пользователя.

Для изучения процесса передачи сетевых пакетов иследует обратится к исходному коду системы в файле `contrib/linux-6.18/net/xdp/xsk.c` и к части функций драйвера «IGB»: `contrib/linux-6.18/drivers/net/ethernet/intel/igb/igb_main.c` и `contrib/linux-6.18/drivers/net/ethernet/intel/igb/igb_xsk.c`.

Получение и отправка пакетов происходит с помощью работы с участком памяти `UMEM`, которая становится доступна драйверу при загрузке в него XDP программы распределения пакетов.

```c
// contrib/linux-6.18/drivers/net/ethernet/intel/igb/igb_xsk.c
// Пример функции установки памяти UMEM и очередей для очереди пакетов `qid`.
int igb_xsk_pool_setup(struct igb_adapter *adapter,
		       struct xsk_buff_pool *pool,
		       u16 qid)
{
	return pool ?
			// Установка памяти UMEM и очередей.
			igb_xsk_pool_enable(adapter, pool, qid) :
			// Их удаление.
			igb_xsk_pool_disable(adapter, qid);
}

```

Сначала рассмотрим процесс получения пакета в `XDP_DRV`.



В процессе описания функции ``


## Разбор примеров

Чтобы работать с программами на основе технологии «EBPF» необходимо установить дополнительные пакеты:

```sh
apt install clang libbpf-dev pkg-config
```

Компиляция программ в код «EBPF» производится системой «clang», с последующей загрузкой скомпилированных команд в ядро с помощью программы «bpftool».

```sh

```

### Настройка сокета

Чтобы захватывать пакеты с помощью системы «AF_XDP», необходимо перевести работу драйвера в 

## Источники

1. [Magnus Karlsson and Bjorn T «The Path to DPDK Speeds for AF XDP»](http://oldvger.kernel.org/lpc_net2018_talks/lpc18_paper_af_xdp_perf-v2.pdf)
2. [Документация ядра «Linux» о «AF_XDP»](https://docs.kernel.org/networking/af_xdp.html)