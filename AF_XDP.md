# Анализ системы AF_XDP

***

В данном разделе разбирается устройство системы AF_XDP, а также примеры её использования.

***

1. [Описание архитектуры]()
   1. [Применяемые механизмы и технологии](#применяемые-механизмы-и-технологии)
   2. [Доступные режимы](#доступные-режимы)
   3. [Процесс передачи сетевых пакетов]()
2. [Разбор примеров]()
   1. [Настройка сокета]()
   2. [Захват и отправка сетевых пакетов]()
3. [Заключение]()
4. [Полезные материалы]()
5. [Источники]()

***

## Описание архитектуры

### Применяемые механизмы и технологии

Аналогично системе «AF_PACKET» использует интерфейс сокетов ядра «Linux» для настройки режима работы. А для передачи пакетов между пользовательским процессом и ядром используется общая память, представляющая собой кольцевой буфер пакетов и имеющая название `UMEM`. При этом в ядре пакеты могут передаваться через структуры `sk_buff` или `xdp_buff`.

### Доступные режимы

Система «AF_XDP» поддерживает два режима работы:

1. `XDP_SKB` — режим работы, при котором данные для копирования в очередь берутся из структуры `sk_buff`;
2. `XDP_DRV` — режим работы, при котором сетевое устройство с помощью технологии DMA записывает пакеты напрямую в память пользовательского пространства.

С помощью установки флага `XDP_SHARED_UMEM` в аргументах системного вызова `bind` появляется возможность создания произвольного количества сокетов с одной разделяемой памятью, где метод распределения пакетов будет определяться XDP-программой загруженной в ядро «linux» и закрепленное за получением пакетов на определённом сетевом интерфейсе.

А при установке параметра `XDP_USE_SG` появляется возможность захватывать пакеты длиной до 9 килобайт, путём объединения буферов (фрагментов на уровне драйвера) в один дескриптор пакета. Захват больших пакетов также возможен через установку флага `XDP_UMEM_UNALIGNED_CHUNK_FLAG` с использованием технологии «hugepages», что с одной стороны увеличивает эффективность использования оперативной памяти из-за записи всех пакетов без пробелов и выравниваний, но увеличивает накладные расходы на управление памятью.

### Процесс передачи сетевых пакетов

Изучить contrib/linux-6.18/net/xdp/xsk.c
Изучить contrib/linux-6.18/drivers/net/ethernet/intel/igb/igb_main.c
Изучить contrib/linux-6.18/drivers/net/ethernet/intel/igb/igb_xsk.c

## Разбор примеров

Чтобы работать с программами на основе технологии «EBPF» необходимо установить дополнительные пакеты:

```sh
apt install clang libbpf-dev pkg-config
```

Компиляция программ в код «EBPF» производится системой «clang», с последующей загрузкой скомпилированных команд в ядро с помощью программы «bpftool».

```sh

```

### Настройка сокета

Чтобы захватывать пакеты с помощью системы «AF_XDP», необходимо перевести работу драйвера в 