# Анализ системы DPDK

***

В данном разделе разбирается устройство системы DPDK, а также примеры её использования.

***

1. [Описание архитектуры](#описание-архитектуры)
    1. [Применяемые механизмы и технологии](#применяемые-механизмы-и-технологии)
    2. [Доступные режимы](#доступные-режимы)
    3. [Процесс передачи сетевых пакетов](#процесс-передачи-сетевых-пакетов)
2. [Разбор примеров](#разбор-примеров)
    1. [Настройка сетевого интерфейса](#настройка-сетевого-интерфейса)
    2. [Захват и отправка сетевых пакетов](#захват-и-отправка-сетевых-пакетов)
3. [Заключение](#заключение)
4. [Полезные материалы](#полезные-материалы)
5. [Источники](#источники)

***

## Описание архитектуры

### Применяемые механизмы и технологии

Система «DPDK» уходит от использования сетевого стека ядра «Linux» и использует свои драйвера, работающие в пространстве пользователя. Но для передачи данных и прерываний между драйвером пользовательского пространства используются механизмы «VFIO» или «UIO» ядра «Linux» [1].

Оба механизма используются для предоставления доступа к памяти и регистрам PCI-устройства в пользовательском пространстве. При этом «VFIO» является более защищенной и надёжной, так как использует механизм «IOMMU», который обеспечивает доступ к памяти и регистрам PCI-устройства по виртуальным адресам, тогда как в «UIO» для обращении к памяти использует указатели на физическую память [2].

Помимо этого система «DPDK» фиксирует потоки захвата/отправки сетевых пакетов на ядрах процессора и управляет памятью в зависимости от настроек технологии «NUMA».

### Доступные режимы

«DPDK» по умолчанию организовывает ожидание пакетов с помощью активного ожидания, то есть непрерывного опроса регисторов устройства. Такой метод ожидания сетевых пакетов сильно нагружает ядро. Поэтому в системе доступна работа с прерываниями PCI-устройства.

Кроме этого система использует различные функции для работы с механизмами «VFIO» и «UIO», но это не влияет на организацию захвата/отправки сетевых пакетов при использовании «DPDK» из-за хорошего уровня абстракции.

### Процесс передачи сетевых пакетов
<!--
Описание структуры памяти.

Описание структуры rte_igb_pmd.

Описание функций:
- rte_eth_rx_burst
- eth_igb_recv_pkts
- rte_eth_tx_burst
- eth_igb_xmit_pkts
 -->

## Разбор примеров

## Настройка сетевого интерфейса
<!--
```sh
apt install meson ninja-build python3-pyelftools libnuma-dev pkg-config libssl-dev
meson setup build \
    -Dexamples=skeleton \
    -Dmachine=native \
    -Doptimization=2 \
    -Ddebug=true
cd build
ninja

# Заёпуск
modprobe vfio
modprobe vfio-pci
modprobe uio_pci_generic
echo 1024 > /sys/kernel/mm/hugepages/hugepages-2048kB/nr_hugepages
ip link set down dev enp3s0
dpdk-devbind.py -b uio_pci_generic enp3s0
dpdk-devbind.py --status
```
 -->


1. [Документация ядра «Linux» о механизме «UIO»](https://www.kernel.org/doc/html/latest/driver-api/uio-howto.html)
2. [Документация ядра «Linux» о механизме «VFIO»](https://www.kernel.org/doc/html/latest/driver-api/vfio-mediated-device.html)