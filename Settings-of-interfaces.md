# Настройка сетевых интерфейсов

***

В данном разделе разбираются способы настройки работы сетевых интерфейсов, что позволяет при использовании систем захвата сетевого трафика, основанных на сетевом стеке ядра «Linux», точечно настроить их работу и производительность.

***

1. [Настройка с помощью параметров драйвера](#настройка-с-помощью-параметров-драйвера)
2. [Настройка с помощью ip](#настройка-с-помощью-ip)
3. [Настройка с помощью ethtool](#настройка-с-помощью-ethtool)
4. [Настройка прерываний](#настройка-прерываний)
5. [Полезные материалы](#полезные-материалы)
6. [Источники](#источники)

***

## Настройка с помощью параметров драйвера

Параметры работы драйвера задаются при вызове программ `modprobe` или `insmod` после названия модуля. Чтобы узнать список доступных параметров, нужно воспользоваться программой `modinfo`, которая выводит информацию о модуле, включая его параметры [1].

```sh
# Пример вывода параметров модуля igb
modinfo ./src/igb.ko | grep "parm"
```

Рассмотрим основные из них:

- `InterruptThrottleRate` — минимальный интервал между прерываниями;
- `IntMode` — тип прерываний (см. [Полезные материалы](#полезные-материалы));
- `RSS` — количество очередей с распределением пакетов на основе адресов и портов;
- `QueuePairs` — включение обработки получения и отправки пакетов одним прерыванием;
- `LRO` — включение объединения пакетов в один на основе адресов и портов;
- `debug` — настройка вывода вспомогательных сообщений.

```bash
# Пример запуска модуля igb c распределением пакетов по двум очередям RSS,
# а также установка для каждой очереди получения и отправки своего прерывания
insmod ./src/igb.ko RSS=2 QueuePairs=0 InterruptThrottleRate=0
```

## Настройка с помощью ip

Программа `ip` является основным инструментом настройки сетевого стека ядра «Linux». Команда `link` отвечает за настройку сетевого интерфейса. С помощью сочетания `ip link set` можно настроить следующие основные параметры [2]:

- `up/down` — включение/выключение сетевого интерфейса;
- `promisc on/off` — захват сетевой картой пакетов независимо от адреса получателя;
- `mtu NUMBER` — максимальный размер пакета, который может передаваться без фрагментации на уровне IP.
- `address LLADDRESS` — настройка MAC-адреса;
- `xdp` — настройка подсистемы XDP.

```bash
# Примеры использования программы ip
# Настройка MAC-адреса
ip link set address d6:5d:8a:6c:30:b2 dev enp2s0
# Установка режима promisc
ip link set promisc on dev enp2s0
# Установка MTU
ip link set mtu 3000 dev enp2s0
```

## Настройка с помощью ethtool

Более точная настройка сетевого интерфейса доступна с помощью программы `ethtool`, возможности которой определяются драйвером сетевого интерфейса (см. src/igb_ethtool.c). Опишем основные параметры `ethtool` и их влияние на работу сетевого интерфейса [3]:

- `DEV` — вывод общей информации о сетевом интерфейсе;
- `-A DEV autoneg on|off` — включение/отключение автоопределения скорости и режима сетевого интерфейса;
- `-A DEV rx|tx on|off` — включение/отключение поддержки сообщений с указанием паузы для конкретной очереди;
- `-g DEV` — вывод информации о текущих настройках очередей пакетов, а также о их максимальных значениях;
- `-G DEV rx|tx NUMBER` — настройка количества дескрипторов в очереди получения/отправки пакетов;
- `-G DEV rx-buf-len LEN` — настройка длины буфера для получения пакетов;
- `-i DEV` — вывод информации о названии драйвера сетевого интерфейса;
- `-k DEV` — вывод информации о функциях драйвера;
- `-K DEV rx|tx on|off` — включение/отключение проверку чек-сумм для соответствующей очереди;
- `-K DEV tso|ufo|gso|gro|lro on|off` — настройка объединения пакетов и/или заголовков (см. [3]);
- `-K DEV rxvlan|txvlan on|off` — включение/отключение аппаратного управления VLAN для соответствующей очереди;
- `-l DEV` — вывод информации об очередях получения/отправки пакетов;
- `-L DEV rx|tx|other|combined NUMBER` — настройка количества очередей определённого типа;
- `-m DEV` — вывод информации о SFP модуле через чтение EEPROM памяти;
- `-p DEV` — включение мигания сетевого интерфейса;
- `-S DEV` — вывод статистики получения/отправки пакетов;
- `-s DEV` — настройка основных параметров сетевого интерфейса (скорость, режим, номер VLAN и тд.);
- `--set-tunable DEV rx-copybreak|tx-copybreak LEN` — настройка максимальной длины пакета, который можно скопировать в структуру `sk_buff` и не использовать фрагменты памяти (см. [получение сетевых пакетов](Linux-network-stack.md#получение-сетевых-пакетов)).

```bash
# Примеры использования ethtool
# Вывод общей информации о сетевом интерфейсе
ethtool enp2s0
# Отключение паузы и автоопределения скорости и режима
ethtool -A enp2s0 autoneg off rx off tx off
# Установка 4-х очередей получения/отправки пакетов
# (QueuePairs в параметрах драйвера должен быть равен 1)
ethtool -L enp2s0 combined 4
```

## Настройка прерываний

Чтобы узнать информацию о прерываниях, необходимо прочитать файл `/proc/interrupts`, который содержит в себе:

- номера прерываний;
- количество полученных прерываний на отдельном логическом процессоре;
- тип прерывания и адрес устройства;
- название источника.

Также подсистема `/proc` позволяет настроить то, на каких логических процессорах может обрабатываться прерывание. Эта настройка установливается двумя путями:

1. Запись маски в шестнадцатеричном формате в файл `/proc/irq/<номер прерывания>/smp_affinity`;
2. Запись массива чисел в файл `/proc/irq/<номер прерывания>/smp_affinity_list`.

```bash
# Пример настройки привязки прерываний
# Вывод информации о прерываниях
cat /proc/interrupts
# Пример вывода:
# 48: 471 0 PCI-MSIX-0000:02:00.0 1-edge enp2s0-TxRx-0
# ^- номер прерывания
# Привязка прерывания на первый логический процессор
echo 1 > /proc/irq/48/smp_affinity
# или
echo 0 > /proc/irq/48/smp_affinity_list
```

## Полезные материалы

1. [Документация ядра «Linux» о технологии MSI](https://docs.kernel.org/PCI/msi-howto.html)
2. [Документация ядра «Linux» о технологии RSS](https://www.kernel.org/doc/html/latest/networking/scaling.html)

## Источники

1. [Документация ядра «Linux» о драйвере igb](https://www.kernel.org/doc/html/latest/networking/device_drivers/ethernet/intel/igb.html)
2. [Описание команды ip](https://man7.org/linux/man-pages/man8/ip-link.8.html)
3. [Описание команды ethtool](https://man7.org/linux/man-pages/man8/ethtool.8.html)
